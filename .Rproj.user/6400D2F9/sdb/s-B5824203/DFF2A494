{
    "collab_server" : "",
    "contents" : "\ny2012 <- read.csv(\"data/2012_election_results.csv\", stringsAsFactors=F)\ny2012 <- y2012[1:169,]\n\nsource(\"keys.R\")\nlibrary(censusapi)\nlibrary(jsonlite)\nlibrary(dplyr)\nlibrary(purrr)\nlibrary(tidyr)\nlibrary(scales)\nlibrary(ggplot2)\nlibrary(ggalt)\nlibrary(stringr)\nlibrary(rgdal)\nrequire(maptools)\nlibrary(RCurl)\nlibrary(twitteR)\nlibrary(lubridate)\nelection_data_url <- \"https://s3.amazonaws.com/election-data-2016/data/Electiondata_1.json\"\n\nlookup_url <- \"https://s3.amazonaws.com/election-data-2016/data/Lookupdata_1.json\"\n\n\nelection_data <- fromJSON(election_data_url, simplifyVector=F)\n#town_results <- data.frame((election_data[[6]]))\ntown_results <- data.frame((election_data[[7]]))\ntown_results <- data.frame(t(town_results))\ntown_results$details <- rownames(town_results) \nrownames(town_results) <- NULL\ntown_results$type <- \"\"\n\ntown_results$type <- ifelse(grepl(\".TO\", town_results$details), \"percent_votes\", \"votes\")\ntown_results$candidate <- town_results$details\ntown_results$candidate <- gsub(\".TO\", \"\", town_results$candidate)\ntown_results$candidate <- gsub(\".V\", \"\", town_results$candidate)\ntown_results$town <- gsub(\"\\\\..*\", \"\", town_results$candidate)\ntown_results$town <- gsub(\"X\", \"\", town_results$town)\ntown_results$candidate <- gsub(\".*\\\\.\", \"\", town_results$candidate)\ntown_results$details <- NULL\ntown_results$number <- town_results$t.town_results.\ntown_results$t.town_results. <- NULL\n\nlookup_data <- fromJSON(lookup_url, simplifyVector=F)\ntown_id <- data.frame((lookup_data[[10]]))\ntown_id <- data.frame(t(town_id))\ntown_id$town <- rownames(town_id)\nrownames(town_id) <- NULL\ntown_id$town <- gsub(\"X\", \"\", town_id$town)\n\ntown_results <- left_join(town_results, town_id)\n\ncandidate_id <- data.frame((lookup_data[[3]]))\ncandidate_id <- data.frame(t(candidate_id))\ncandidate_id$details <- rownames(candidate_id)\ncandidate_id$cat <- \"\"\ncandidate_id$cat <- ifelse(grepl(\".CO\", candidate_id$details), \"county\", candidate_id$cat)\ncandidate_id$cat <- ifelse(grepl(\".NM\", candidate_id$details), \"name\", candidate_id$cat)\ncandidate_id$cat <- ifelse(grepl(\".LN\", candidate_id$details), \"last\", candidate_id$cat)\ncandidate_id$cat <- ifelse(grepl(\".MN\", candidate_id$details), \"middle\", candidate_id$cat)\ncandidate_id$cat <- ifelse(grepl(\".P\", candidate_id$details), \"party\", candidate_id$cat)\ncandidate_id$cat <- ifelse(grepl(\".FN\", candidate_id$details), \"first\", candidate_id$cat)\ncandidate_id$cat <- ifelse(grepl(\".AD\", candidate_id$details), \"address\", candidate_id$cat)\ncandidate_id$candidate <- gsub(\"\\\\..*\", \"\", candidate_id$details)\ncandidate_id$candidate <- gsub(\"X\", \"\", candidate_id$candidate)\ncandidate_id$details <- NULL\ncandidate_id$text <- candidate_id$t.candidate_id.\ncandidate_id$t.candidate_id. <- NULL\ncandidate_id <- spread(candidate_id, cat, text)\n\ntown_results <- left_join(town_results, candidate_id)\n\n\nparty_id <- data.frame((lookup_data[[7]]))\nparty_id <- data.frame(t(party_id))\nparty_id$details <- rownames(party_id)\nrownames(party_id) <- NULL\nparty_id$category <- \"\"\nparty_id$category <- ifelse(grepl(\".P\", party_id$details), \"party_p\", party_id$category)\nparty_id$category <- ifelse(grepl(\".NM\", party_id$details), \"party_name\", party_id$category)\nparty_id$category <- ifelse(grepl(\".CD\", party_id$details), \"party_abbr\", party_id$category)\nparty_id$party <- gsub(\"\\\\..*\", \"\", party_id$details)\nparty_id$party <- gsub(\"X\", \"\", party_id$party)\n\nparty_id$details <- NULL\nparty_id <- spread(party_id, category, t.party_id.)\n\ntown_results <- left_join(town_results, party_id)\n\n\n\npres_results <- filter(town_results, type==\"percent_votes\") %>%\n  filter(first==\"Donald\" | first==\"Hillary\" | first==\"Jill\" | name==\"Johnson and Weld\") %>%\n  select(number, t.town_id., name)\n\ncolnames(pres_results) <- c(\"percent\", \"id\", \"candidate\")\npres_results$percent <- gsub(\"%\", \"\", pres_results$percent)\npres_results$percent <- as.numeric(pres_results$percent )\npres_results <- pres_results  %>%\n  spread(candidate, percent)\n\n\npres_results$winner <- \"\"\npres_results$winner <- ifelse((pres_results$`Clinton and Kaine` ==  pres_results$`Trump and Pence`), \"Tie\", pres_results$winner)\npres_results$winner <- ifelse((pres_results$`Clinton and Kaine`==0 & pres_results$`Trump and Pence`==0), \"Results not ready\", pres_results$winner)\npres_results$winner <- ifelse((pres_results$`Clinton and Kaine` >  pres_results$`Trump and Pence`), \"Clinton\", pres_results$winner)\npres_results$winner <- ifelse((pres_results$`Clinton and Kaine` <  pres_results$`Trump and Pence`), \"Trump\", pres_results$winner)\npres_results$winner <- factor(pres_results$winner, levels = c(\"Clinton\", \"Trump\", \"Tie\", \"Results not ready\"))\n\n\ntotal_results <- filter(town_results, type==\"votes\") %>%\n  filter(first==\"Donald\" | first==\"Hillary\" | first==\"Jill\" | name==\"Johnson and Weld\") %>%\n  select(number, t.town_id., name)\n\ncolnames(total_results) <- c(\"percent\", \"id\", \"candidate\")\ntotal_results$percent <- gsub(\"%\", \"\", total_results$percent)\ntotal_results$percent <- as.numeric(total_results$percent )\ntotal_results <- total_results  %>%\n  spread(candidate, percent)\n\ntotal_results$winner <- \"\"\ntotal_results$winner <- ifelse((total_results$`Clinton and Kaine` ==  total_results$`Trump and Pence`), \"Tie\", total_results$winner)\ntotal_results$winner <- ifelse((total_results$`Clinton and Kaine`==0 & total_results$`Trump and Pence`==0), \"Results not ready\", total_results$winner)\ntotal_results$winner <- ifelse((total_results$`Clinton and Kaine` >  total_results$`Trump and Pence`), \"Clinton\", total_results$winner)\ntotal_results$winner <- ifelse((total_results$`Clinton and Kaine` <  total_results$`Trump and Pence`), \"Trump\", total_results$winner)\ntotal_results$winner <- factor(total_results$winner, levels = c(\"Clinton\", \"Trump\", \"Tie\", \"Results not ready\"))\n\n\ncolnames(total_results) <- c(\"Town\", \"Clinton\", \"Johnson16\", \"Stein\", \"Trump\", \"winner\")\ncolnames(pres_results) <- c(\"Town\", \"Clinton\", \"Johnson16\", \"Stein\", \"Trump\", \"winner\")\n\np2012 <- y2012\np2012$Romney <- round(y2012$Romney/(y2012$Romney+y2012$Obama+y2012$Anderson+ y2012$Johnson)*100,2)\np2012$Obama <- round(y2012$Obama/(y2012$Romney+y2012$Obama+y2012$Anderson+ y2012$Johnson)*100,2)\np2012$Anderson <- round(y2012$Anderson/(y2012$Romney+y2012$Obama+y2012$Anderson+ y2012$Johnson)*100,2)\np2012$Johnson <- round(y2012$Johnson/(y2012$Romney+y2012$Obama+y2012$Anderson+ y2012$Johnson)*100,2)\n\n\ntot <- left_join(y2012, total_results)\nper <- left_join(p2012, pres_results)\n\nper$TCdiff <- per$Trump-per$Clinton\nper$ROdiff <- per$Romney-per$Obama\n\nper$COdiff <- per$Clinton-per$Obama\nper$TRdiff <- per$Trump-per$Romney\n\n# margins\nlibrary(knitr)\n\ntot$vote_diff <- tot$Clinton-tot$Trump\ntot <- arrange(tot, vote_diff)\ntot <- subset(tot, (vote_diff<6) & (vote_diff > -6))\ntot <- subset(tot, winner!=\"Results not ready\")\nkable(tot)\n\n# where Clinton lead the most\n\nper_margins <- arrange(per, TCdiff)\nper_margins <- subset(per_margins, winner!=\"Results not ready\")\n\nclinton_lead <- head(per_margins, 5)\nkable(clinton_lead)\n\ntrump_lead <- tail(per_margins, 5)\nkable(trump_lead)\n\n\n## Obama versus Clinton\n\nlibrary(ggalt)\n\nper$Trump[per$Trump == 0.00] <- NA\nper$Clinton[per$Clinton == 0.00] <- NA\n\nper <- subset(per, !is.na(per$Clinton))\n\n# start here\n\nper <- arrange(per, Clinton)\nper$Town <- factor(per$Town, levels=unique(per$Town))\n\nper$arrange_hc <- ifelse(per$Clinton < 50 & per$Clinton < per$Obama, per$Clinton - 8, 0)\nper$arrange_hc <- ifelse(per$Clinton < 50 & per$Clinton > per$Obama, per$Obama - 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Clinton > 50 & per$Clinton > per$Obama, per$Clinton + 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Clinton > 50 & per$Clinton < per$Obama, per$Obama + 8, per$arrange_hc)\n\ngg <- ggplot()\ngg <- gg + geom_dumbbell(data=per, aes(x=Clinton, xend=Obama, y=Town, group=Town), color=\"#a3c4dc\", size=0.5, point.colour.l=\"#0e668b\")\n# gg <- gg + scale_x_continuous(label=percent)\ngg <- gg + labs(x=NULL, y=NULL)\ngg <- gg + scale_x_continuous(limits = c(0, 110))\ngg <- gg + theme_bw()\ngg <- gg + theme(axis.title = element_text(family = \"Lato Black\", color=\"#666666\", face=\"bold\", size=6)) \ngg <- gg + theme(plot.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.grid.major.y=element_blank())\ngg <- gg + theme(panel.grid.major.x=element_line())\ngg <- gg+ geom_vline(xintercept = 50)\ngg <- gg+ geom_vline(xintercept = 20, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 40, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 60, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 80, linetype=\"dotted\", colour=\"lightgray\")\n\ngg <- gg + theme(axis.ticks=element_blank())\n#gg <- gg + theme(axis.text = element_text(size = 4))\ngg <- gg + labs(title = \"Support for Clinton and Obama\",\n                subtitle= \"Percent of votes in 2012 compared to 2016\",\n                caption=\"Office of the Secretary of the State \\n Andrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=19))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + annotate(\"text\", x = 13.2, y = 150, label = \"Barack Obama\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"text\", x = 12.8, y = 153, label = \"Hillary Clinton\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"point\", x = 3, y = 150, colour = \"#a3c4dc\", size = 2) \ngg <- gg + annotate(\"point\", x = 3, y = 153, colour = \"#0e668b\", size = 2)\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(axis.text.y = element_text(family=\"Lato Regular\", size=12))\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.text.y =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.grid.major = element_blank(),\n                 panel.grid.minor = element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg <- gg + geom_text(data=per, aes(x=arrange_hc, y=Town,  family=\"Lato\", label=Town), size=2)\n\nggsave(gg, file=\"output/hillary_obama_1.png\", width=6, height=12, type=\"cairo-png\")\n\nftp_url <- paste0(\"ftp://\", ftp_login, \"@secure.ctmirror.org/projects.ctmirror.org/content/trend/2016/11/election/analysis/hillary_obama_1.png\")\nftpUpload(\"output/hillary_obama_1.png\", ftp_url)\n\n# OK, alphabetical\n\nper <- arrange(per, desc(as.character(Town)))\nper$Town <- factor(per$Town, levels=unique(per$Town))\n\nper$arrange_hc <- ifelse(per$Clinton < 50 & per$Clinton < per$Obama, per$Clinton - 8, 0)\nper$arrange_hc <- ifelse(per$Clinton < 50 & per$Clinton > per$Obama, per$Obama - 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Clinton > 50 & per$Clinton > per$Obama, per$Clinton + 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Clinton > 50 & per$Clinton < per$Obama, per$Obama + 8, per$arrange_hc)\n\n\ngg <- ggplot(per, aes(x=Clinton, xend=Obama, y=Town, group=Town))\ngg <- gg + geom_dumbbell(color=\"#a3c4dc\", size=0.5, point.colour.l=\"#0e668b\")\n# gg <- gg + scale_x_continuous(label=percent)\ngg <- gg + labs(x=NULL, y=NULL)\ngg <- gg + scale_x_continuous(limits = c(0, 110))\ngg <- gg + theme_bw()\ngg <- gg + theme(axis.title = element_text(family = \"Lato Black\", color=\"#666666\", face=\"bold\", size=6)) \ngg <- gg + theme(plot.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.grid.major.y=element_blank())\ngg <- gg + theme(panel.grid.major.x=element_line())\ngg <- gg+ geom_vline(xintercept = 50)\ngg <- gg+ geom_vline(xintercept = 20, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 40, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 60, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 80, linetype=\"dotted\", colour=\"lightgray\")\n\ngg <- gg + theme(axis.ticks=element_blank())\n#gg <- gg + theme(axis.text = element_text(size = 4))\ngg <- gg + labs(title = \"Support for Clinton and Obama\",\n                subtitle= \"Percent of votes in 2012 compared 2016\",\n                caption=\"Office of the Secretary of the State \\n Andrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=19))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\n\ngg <- gg + annotate(\"text\", x = 13.2, y = 150, label = \"Barack Obama\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"text\", x = 12.8, y = 153, label = \"Hillary Clinton\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"point\", x = 3, y = 150, colour = \"#a3c4dc\", size = 2) \ngg <- gg + annotate(\"point\", x = 3, y = 153, colour = \"#0e668b\", size = 2)\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(axis.text.y = element_text(family=\"Lato Regular\", size=12))\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.text.y =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.grid.major = element_blank(),\n                 panel.grid.minor = element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg <- gg + geom_text(aes(x=arrange_hc, y=Town,  family=\"Lato\", label=Town), size=2)\n\nggsave(gg, file=\"output/hillary_obama_2.png\", width=6, height=12, type=\"cairo-png\")\nftp_url <- paste0(\"ftp://\", ftp_login, \"@secure.ctmirror.org/projects.ctmirror.org/content/trend/2016/11/election/analysis/hillary_obama_2.png\")\nftpUpload(\"output/hillary_obama_2.png\", ftp_url)\n\n# Trump versus Romney\n\n# start here\n\nper <- arrange(per, Trump)\nper$Town <- factor(per$Town, levels=unique(per$Town))\n\nper$arrange_hc <- ifelse(per$Trump < 50 & per$Trump < per$Romney, per$Trump - 8, 0)\nper$arrange_hc <- ifelse(per$Trump < 50 & per$Trump > per$Romney, per$Romney - 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Trump > 50 & per$Trump > per$Romney, per$Trump + 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Trump > 50 & per$Trump < per$Romney, per$Romney + 8, per$arrange_hc)\n\ngg <- ggplot()\ngg <- gg + geom_dumbbell(data=per, aes(x=Trump, xend=Romney, y=Town, group=Town), color=\"tomato1\", size=0.5, point.colour.l=\"red4\")\n# gg <- gg + scale_x_continuous(label=percent)\ngg <- gg + labs(x=NULL, y=NULL)\ngg <- gg + scale_x_continuous(limits = c(0, 110))\ngg <- gg + theme_bw()\ngg <- gg + theme(axis.title = element_text(family = \"Lato Black\", color=\"#666666\", face=\"bold\", size=6)) \ngg <- gg + theme(plot.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.grid.major.y=element_blank())\ngg <- gg + theme(panel.grid.major.x=element_line())\ngg <- gg+ geom_vline(xintercept = 50)\ngg <- gg+ geom_vline(xintercept = 20, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 40, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 60, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 80, linetype=\"dotted\", colour=\"lightgray\")\n\ngg <- gg + theme(axis.ticks=element_blank())\n#gg <- gg + theme(axis.text = element_text(size = 4))\ngg <- gg + labs(title = \"Support for Trump and Romney\",\n                subtitle= \"Percent of votes in 2012 compared to 2016\",\n                caption=\"Office of the Secretary of the State \\n Andrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=19))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + annotate(\"text\", x = 11.8, y = 150, label = \"Mitt Romney\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"text\", x = 12.8, y = 153, label = \"Donald Trump\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"point\", x = 3, y = 150, colour = \"tomato1\", size = 2) \ngg <- gg + annotate(\"point\", x = 3, y = 153, colour = \"red4\", size = 2)\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(axis.text.y = element_text(family=\"Lato Regular\", size=12))\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.text.y =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.grid.major = element_blank(),\n                 panel.grid.minor = element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg <- gg + geom_text(data=per, aes(x=arrange_hc, y=Town,  family=\"Lato\", label=Town), size=2)\n\nggsave(gg, file=\"output/trump_romney_1.png\", width=6, height=12, type=\"cairo-png\")\n\nftp_url <- paste0(\"ftp://\", ftp_login, \"@secure.ctmirror.org/projects.ctmirror.org/content/trend/2016/11/election/analysis/trump_romney_1.png\")\nftpUpload(\"output/trump_romney_1.png\", ftp_url)\n\n# OK, alphabetical\n\nper <- arrange(per, desc(as.character(Town)))\nper$Town <- factor(per$Town, levels=unique(per$Town))\n\nper$arrange_hc <- ifelse(per$Trump < 50 & per$Trump < per$Romney, per$Trump - 8, 0)\nper$arrange_hc <- ifelse(per$Trump < 50 & per$Trump > per$Romney, per$Romney - 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Trump > 50 & per$Trump > per$Romney, per$Trump + 8, per$arrange_hc)\nper$arrange_hc <- ifelse(per$Trump > 50 & per$Trump < per$Romney, per$Romney + 8, per$arrange_hc)\n\n\ngg <- ggplot(per, aes(x=Trump, xend=Romney, y=Town, group=Town))\ngg <- gg + geom_dumbbell(color=\"tomato1\", size=0.5, point.colour.l=\"red4\")\n# gg <- gg + scale_x_continuous(label=percent)\ngg <- gg + labs(x=NULL, y=NULL)\ngg <- gg + scale_x_continuous(limits = c(0, 110))\ngg <- gg + theme_bw()\ngg <- gg + theme(axis.title = element_text(family = \"Lato Black\", color=\"#666666\", face=\"bold\", size=6)) \ngg <- gg + theme(plot.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.background=element_rect(fill=\"#f7f7f7\"))\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.grid.major.y=element_blank())\ngg <- gg + theme(panel.grid.major.x=element_line())\ngg <- gg+ geom_vline(xintercept = 50)\ngg <- gg+ geom_vline(xintercept = 20, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 40, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 60, linetype=\"dotted\", colour=\"lightgray\")\ngg <- gg+ geom_vline(xintercept = 80, linetype=\"dotted\", colour=\"lightgray\")\n\ngg <- gg + theme(axis.ticks=element_blank())\n#gg <- gg + theme(axis.text = element_text(size = 4))\ngg <- gg + labs(title = \"Support for Trump and Romney\",\n                subtitle= \"Percent of votes in 2012 compared 2016\",\n                caption=\"Office of the Secretary of the State \\n Andrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=19))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\n\ngg <- gg + annotate(\"text\", x = 11.8, y = 150, label = \"Mitt Romney\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"text\", x = 12.8, y = 153, label = \"Donald Trump\", size=3, colour=\"gray30\")\ngg <- gg + annotate(\"point\", x = 3, y = 150, colour = \"tomato1\", size = 2) \ngg <- gg + annotate(\"point\", x = 3, y = 153, colour = \"red4\", size = 2)\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(axis.text.y = element_text(family=\"Lato Regular\", size=12))\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.text.y =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.grid.major = element_blank(),\n                 panel.grid.minor = element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg <- gg + geom_text(aes(x=arrange_hc, y=Town,  family=\"Lato\", label=Town), size=2)\n\nggsave(gg, file=\"output/trump_romney_2.png\", width=6, height=12, type=\"cairo-png\")\nftp_url <- paste0(\"ftp://\", ftp_login, \"@secure.ctmirror.org/projects.ctmirror.org/content/trend/2016/11/election/analysis/trump_romney_2.png\")\nftpUpload(\"output/trump_romney_2.png\", ftp_url)\n\n\n# By town type\n\nurban <- read.csv(\"data/urban_rural.csv\", stringsAsFactors=FALSE)\nurban <- urban[c(\"NAME10\", \"Type\")]\ncolnames(urban) <- c(\"Town\", \"Type\")\n\nper <- left_join(per, urban)\ntotal_results <- left_join(total_results, urban)\n\ntown_type_analysis <-per %>%\n   select(Town, Type, Trump, Clinton) %>%\n   gather(\"candidate\", \"percent\", 3:4)\n\ngg <- ggplot(town_type_analysis, aes(x = Type, y = percent, fill = candidate)) \ngg <- gg + geom_boxplot() \ngg <- gg + scale_fill_manual(values= c(\"Clinton\" = \"lightskyblue\", \"Trump\"=\"tomato\"))\ngg <- gg + labs(x=NULL, y=NULL, \n                title=\"Presidential support by town type\",\n                subtitle=\"Trump got the rural voters in Connecticut while voters in \\nurban cities supported Clinton\",\n                caption=\"Source: Office of the Secretary of the State \\n Andrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=24))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + theme(axis.text.x = element_text(family=\"Lato Regular\", size=15))\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.grid.major = element_blank(),\n                 panel.grid.minor = element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg\n\n\n# By whiteness of town\n\nrace_towns <- getCensus(name=\"acs5\",\n                        vintage=2014,\n                        key=census_key,\n                        vars=c(\"NAME\", \"B02001_001E\", \"B02001_002E\", \"B02001_003E\",\n                               \"B02001_004E\", \"B02001_005E\", \"B03001_003E\"),\n                        region=\"county subdivision:*\", regionin=\"state:09\")\n\ncolnames(race_towns) <- c(\"town\", \"state\", \"county\", \"countysub\", \"total_pop\", \"White\", \"Black\", \"Indian\", \"Asian\", \"Hispanic\")\nrace_towns <- race_towns[c(\"town\", \"total_pop\", \"White\", \"Black\", \"Indian\", \"Asian\", \"Hispanic\")]\nrace_towns <- subset(race_towns, !grepl(\"County subdivisions\", town))\nrace_towns$town <- gsub(\" town.*\", \"\", race_towns$town)\n\nrace_towns_long <- race_towns %>%\n  gather(\"race_ethnicity\", \"population\", 3:7) %>%\n  mutate(percent_population=round(population/total_pop*100,2))\n\nrace_towns_white <- race_towns_long %>%\n  filter(race_ethnicity==\"White\") %>%\n  select(town, percent_population)\n\ncolnames(race_towns_white) <- c(\"Town\", \"Percent_White\")\n\nper <- left_join(per, race_towns_white)\n\ngg <- ggplot(per, aes(Percent_White, Trump))\ngg <- gg + geom_point()\ngg <- gg + labs(x=\"Percent white population\", y=\"Percent votes for Trump\", \n                title=\"Trump votes compared to white population\",\n                subtitle=\"The whiter a town, the higher likelihood they supported Donald Trump.\",\n                caption=\"Source: Office of the Secretary of the State \\n Andrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=24))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg <- gg + theme_bw()\ngg\n\n\n# Swapped?\n\nper$winner2012 <- ifelse(per$Obama>per$Romney, \"Obama\", \"Romney\")\nper$flip <- \"\"\nper$flip <- ifelse(per$winner==\"Clinton\" & per$winner2012==\"Obama\", \"Clinton retained\", per$flip)\nper$flip <- ifelse(per$winner==\"Trump\" & per$winner2012==\"Romney\", \"Trump retained\", per$flip)\nper$flip <- ifelse(per$winner==\"Trump\" & per$winner2012==\"Obama\", \"Flipped to Trump\", per$flip)\nper$flip <- ifelse(per$winner==\"Clinton\" & per$winner2012==\"Romney\", \"Flipped to Clinton\", per$flip)\n\ntown_shape <- readOGR(dsn=\"maps\", layer=\"ctgeo\")\ntown_shape_df <- fortify(town_shape, region=\"NAME10\")\n\nnames(per)[names(per) == 'Town'] <- 'id'\n\n\nvoters_map <- left_join(town_shape_df,per)\n\ngg <- ggplot(voters_map, aes(long,lat, group=group))\ngg <- gg + geom_polygon(aes(fill=flip))\ngg <- gg + geom_path(color=\"white\")\ngg <- gg + scale_fill_manual(values= c(\"Clinton retained\"=\"lightskyblue\", \"Flipped to Clinton\" = \"navyblue\", \"Trump retained\"=\"tomato\", \"Flipped to Trump\"=\"red4\"))\ngg <- gg + labs(x=NULL, y=NULL, \n                title=\"Where towns chose or flipped for Clinton or Trump\",\n                #                title=\"Presidential results by town\",\n                #                subtitle=\"Where candidates are currently leading in votes. Results are unofficial.\",\n                subtitle=\"Compared to whether Obama or Romney won in 2012\",\n                caption=\"Source: Office of Secretary of the State \\nAndrew Ba Tran/TrendCT.org\")\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Regular\", size=24))\ngg <- gg + theme(plot.subtitle=element_text(family=\"Lato Regular\", size=17))\ngg <- gg + theme(plot.caption=element_text(family=\"Lato Regular\", size=12, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + theme(axis.line =  element_blank(),\n                 axis.text =  element_blank(),\n                 axis.ticks =  element_blank(),\n                 panel.grid.major = element_blank(),\n                 panel.grid.minor = element_blank(),\n                 panel.border = element_blank(),\n                 panel.background = element_blank(),\n                 legend.title=element_blank()) \ngg <- gg + coord_map(\"sinusoidal\") \n\ngg\n\n#ggsave(gg, file=\"output/pres_map.png\", width=8, height=4, type=\"cairo-png\")",
    "created" : 1478659647222.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "526338730",
    "id" : "DFF2A494",
    "lastKnownWriteTime" : 1478711451,
    "last_content_update" : 1478711451948,
    "path" : "~/Documents/Github/trendct-data/2016/11/election-2016-r/analysis2016.R",
    "project_path" : "analysis2016.R",
    "properties" : {
        "tempName" : "Untitled4"
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}